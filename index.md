# Processing DP0.2 at FrDF: A comparison with DP0.2 catalogs produced at IDF

```{abstract}
The purpose of this note is to compare the final catalogs produced by the processing done in FrDF of the DP0.2 data with the reference catalogs produced at IDF.
```

## Introduction
In this note, we report the results of the comparison between DP0.2 catalogs produced at FrDF and the reference catalog produced at IDF.

In the context of the Data Preview 0.2 (DP0.2), the Data Release Production pipelines have been executed on the DC-2 simulated dataset (generated by the Dark Energy Science Collaboration, DESC).
This dataset includes 20 000 simulated exposures, representing 300 square degrees of Rubin images with a typical depth of 5 years.
DP0.2 ran at the Interim Data Facility, and the full exercise was independently replicated at FrDF (CC-IN2P3) and described in {cite:t}`LeBoulch.2024`.

In this note we will start describing the catalogs and how we retrieved the data.
Then we report the analysis performed on each table, checking two main objectives: how the sources' positions in the sky match, and how the sources' fluxes compare (when applicable).

The data and notebooks used are available in the [CC-IN2P3 GitLab](https://gitlab.in2p3.fr/gabriele.mainetti/dp02_analysis).

## The catalogs in Qserv

The catalogs have been ingested in Qserv production instance at FrDF:
1. dp02_dc2_catalogs_frdf catalog produced at CC-IN2P3 (hereafter FrDF catalog)
2. dp02_dc2_catalogs catalog produced at IDF (hereafter IDF catalog)

For the FrDF catalog, two tables are missing (TruthSummary and MatchesTruth) because that tables require post processing before to be ingested in Qserv.

In the following image you can see the number of line per table in FrDF and IDF catalogs. CcdVisit and Visit, produced by pipeline Step 7, have been produced twice at FrDF. For our scope, the FrDF data have been filtered to remove the rows in double. This problem needs to be adressed: **we have to be able to flag the non valid tables to detect them before the ingestion process**.

```{figure} ./images/table_qserv.png
Number of lines per table in DPO.2 FrDF and IDF catalogs. 
```

It is not possible compare the full catalogs, so for the analysis reported here we used a subsample of both the catalogs selected using a spatial query as this: 

```
SELECT <column1>, <column2>, ...,<columnN> from <table> where scisql_s2PtInCircle(<ra>, <decl>, 60.0, -30.0, 0.5) = 1 limit 5000000
```

We limited the number of retrieved lines to 5M but for tables with a large number of lines (sources) we reduced also the query radius: a radius of 0.5 degree is to large and the number of sources in the area defined by the circle exceed largley the limits we imposed on the number of the lines. For this reason the catalogs retrieved are not comparable because the sources in the tables are not covering the same region as shown in the following image for ForcedSource table retrieved in a radius of 0.5deg, where in red you see the objects extracted from FrDF and in blue the objects extracted from the IDF.

```{figure} ./images/forced_source.png
Example of source extraction not covering the same region. 
```

To reduce the table size we also retrieved a subsamble of columns (ra, dec and fluxes). Only for few small table we retrieved all columns.

The fluxes has been converted to magnitude AB using UDF SQL function `scisql_nanojanskyToAbMag` integrated in Qserv.

All the queries used for each table are reported in query notebook.

The analysis has been performed offline: all the tables have been retrieved once and stored locally as fits files (available in fits directory in this repository). For each table a file called `<df>_<table>.fits` has been generated and for each table a new column (DF) has been added allowing to identify easily the data origin during the analysis.

Topcat has been used to quick validate the retrieved datasets and to filter out the line in double for Visit and CcdVisit tables.

## Comparison

For the analysis there is an interactive notebook allowing table selection and type of plot to generate. For each table we also created a notebook (available in notebook directory) and we generated an interactive html with all the plot (coordinates and magnitudes) and available in the html directory.

We performed a match between the catalogs to make a correct correspondances between the rows and to avoid odd results (i.e comparison between sources in different region of the sky), for this we use astropy module when the number of the row in the retrieved table was the same (in this case it is as we reordered the tables to have match between the row). When the number of row in tables was not the same, we used Topcat stilt functions (as implemented in `pystitls`. We used stilts because it allows the "symmetric match" i.e. it allows only one match per source: with astropy this is not possible and you can have multi-match than could lead to wrong results.

But also with these conditions, in the case of the ForcedSource table the match can be very difficult if not impossible.

To better understand this point see next figures.

The following figure shows the data retrieved for three table:

1. Object in (radius=0.5deg , number of object=395952)
2. Source in (radius=0.1deg , number of object=561385)
3. ForcedSource in (radius=0.05deg , number of object=1643290)

```{figure} ./images/radius.png
Data retrieved for three table:

1. Object in (radius=0.5deg , number of object=395952)
2. Source in (radius=0.1deg , number of object=561385)
3. ForcedSource in (radius=0.05deg , number of object=1643290)

```

In `ForcedSource` we have 4 times more entries than Object table in a region 100 times smaller.

Taking a look to the density of source, we see how it could be complicated for a matching algorithm to find the good match. The next figures show the number of sources per "pixel" in the different tables. The pixel size is:

1. Object table: 12x12 arcsec (we cannot generate smaller pixel)
2. Source table: 7.2x7.2 arcsec
3. ForcedSource table: 7.2x7.2 arcsec

```{figure} ./images/object_pixel.png

Source density in Object table (in 12x12 arcsec "pixel"). 
```

```{figure} ./images/source_pixel.png

Source density in Source table (in 7.2x7.2 arcsec "pixel"). 
```

```{figure} ./images/forced_source_pixel.png

Source density in ForcedSource table (in 7.2x7.2 arcsec "pixel"). 
```

You can see the number of sources per pixel in the right scale: ForcedSource have an incredible number of source per pixel, in some case more than 3k: it's clear that a matching algorithm using a separation of 1arcsec as parameter to match two points, in this case, it cannot be 100% reliable. In our case, if we exclude ForcedSource table, the matching algorithm worked as we expect.

### Sources positions analysis

To analyse how position in the sky of the object match we compared ra,dec and we analysed also the sky separation (i.e. the great-circle distance) estimated using astropy as

```

c1 = SkyCoord(df[ra_1]*u.deg, df[decl_1]*u.deg, frame='icrs')
c2 = SkyCoord(df[ra_2]*u.deg, df[decl_2]*u.deg, frame='icrs') 
sep=c1.separation(c2).degree
```

An exemple of the distribution of the sky separation is visible in the next figure.

```{figure} ./images/object_cord_diff.png
```

### Fluxes (magnitudes) analysis

For the fluxes comparison we converted nJy to magnitude AB.

For each table we select fluxes columns and we convert them to AB magnitude using te UDF function scisql_nanojanskyToAbMagintegrated in Qserv.

Then, for each magnitude we plot the histogram and the box plot of the distribution for each catalogs, as shown in the next figure.

```{figure} ./images/diasource_tot.png
```

We plot also the histogram and the box plot of the distribution of the differences of magnitudes, i.e. the difference calculated per matching source. 

```{figure} ./images/diasource_tot_diff.png
```

For reference, the following image explain the mean of a box plot. 


```{figure} ./images/boxplot.png
```

## Results

The results show a very good compatibility between the catalog produced at FrDF and the one produced at IDF. The positions in the sky are almost the same, with very few differences generally limited to a small number of objects; for example, in the Object table, 80% of the 395,000 sources have a separation of less than 0.015 arcseconds and 90% under 0.06 arcseconds. For some tables, there is no difference at all.

The results for magnitudes are also compatible, with very small differences. For each table, we report the main results in the next section.

You can also check all the results for each table in the appropriate notebook linked in each table's section.

Overall, the coordinates and magnitudes show a very good fit between the catalogs. However, we found some problems, listed here:

1. **ForcedSourceOnDiaObject** produced at **FrDF** has no fluxes: all the flux columns are set to NaN, probably linked to the JIRA ticket **DM-35338**.
2. As mentioned, **Visit** and **CcdVisit** have been produced twice; we have to define a correct procedure in case of reprocessing to avoid this specific case.
3. The **Object** table at **FrDF** shows holes around very bright sources. It's not clear why; it could be linked to changes in how the pipelines process data. To be investigated.
4. **ForcedSource** magnitudes show a larger distribution of differences, but, as mentioned above, it could be linked to a selection effect during the catalog matching.

###  Object Table

The Object table contains astrometric and photometric measurements for objects detected in coadded images (990 columns).

We use a query to retrieve all the objects in the region defined by a circle of 0.5 degrees radius around the center point with coordinates (60.0, -30.0) degrees.

But the number of lines retrieved from both catalogs is not the same: 395,952 for FrDF and 396,373 for IDF. This means that the pipelines produced two different catalogs. Looking at the source distribution, we can see that in the FrDF table there are a few holes around bright sources.

The following figures show the sky maps for the sources produced at FrDF (in red) and at IDF (in blue).

```{figure} ./images/topcat_frdf.png
```

```{figure} ./images/topcat_idf.png
```

We note some large holes in the FrDF data, and if we look at the simulated images, we see extended and bright sources corresponding to the holes described above. See, for example, the following figures.

```{figure} ./images/hips_holes.png
```

Is this due to the different version of the pipeline used?
The analysis is available as notebook (in notebook directory) and as [exported html](https://gitlab.in2p3.fr/gabriele.mainetti/dp02_analysis/-/blob/main/html/Object_match.html?ref_type=heads).

#### Coordinates

After the matching, we obtained two catalogs having the same number of lines (395,865); we lost only a few FrDF sources and 508 IDF sources.

The results show a very good fit in positions; almost all the sources have less than 0.2 arcseconds of separation (see next figure):

```{figure} ./images/object_cord_diff.png
```

We can conclude, with respect to the coordinates, that the processing at FrDF and IDF is equivalent in this case, but we have to find the discrepancy in the number of sources generated.

####  Magnitude

We analyzed the magnitudes in all six bands available in the table. The magnitudes were extracted from the flux called `<band>cModelFlux`, which is described as: "Flux from the final cmodel fit, forced on the `<band>`-band."

For each magnitude, we plotted the distribution for each catalog and the differences between magnitudes for each corresponding source.

The distributions of magnitude in all the bands are almost the same, with only a few outliers, and this is confirmed by the difference distribution.

An example is shown in the following figure, illustrating the distribution of magnitude for the u band (note: both FrDF and IDF are plotted, but the distributions are almost the same. Please use the interactive notebook or interactive HTML to check it):

```{figure} ./images/object_u.png
```

As mentioned, the distributions are almost indistinguishable, and this is also confirmed by the distribution of the magnitude differenceâ€”for example, for the u band, as shown in the next image:

```{figure} ./images/object_u_diff.png
```
The charts above (and for all other photometric bands) could be generated via [interactive notebook](https://gitlab.in2p3.fr/gabriele.mainetti/dp02_analysis/-/blob/main/notebooks/interactive_notebook.ipynb?ref_type=heads) or explored via [interactive HTML](https://gitlab.in2p3.fr/gabriele.mainetti/dp02_analysis/-/blob/main/html/Object_match.html?ref_type=heads). 

Also regarding magnitude, we can conclude that the object table produced at FrDF is equivalent to the one produced at IDF  (with the caveat about the difference in the number of sources; see above).


### Source Table
The Source table contains astrometric and photometric measurements for sources detected in the individual PVIs (143 columns).

For the source table we used a query with a small radius (0.01 deg) to avoid problem in catalogs matching.
In this case the number of sources available in the two catalogs is the same (561385).


#### Coordinates

In this case there are no evident holes or discrepancies in the plotted positions, see the above figure where in red you have the source from IDF and in blue the one from FrDF.

```{figure} ./images/topcat_sources.png
```

And also the further analysis show that there are no differences at all between Source's position derived a FrDF and derived at IDF.

```{figure} ./images/source_diff.png
```

#### Magnitudes

For the magnitudes, we analyzed data derived from 13 flux measurements: 9 magnitudes estimated at different apertures (converted from ap\<aperture\>Flux, which is the flux within a \<aperture\>-pixel aperture), and 4 other magnitudes:

- **skymag** from **skyFlux**: background flux in annulus around the source
- **psfmag** from **psfFlux**: flux derived from linear least-squares fit of PSF model forced on the calexp
- **gaussianmag** from **GaussianFlux**: flux from Gaussian Flux algorithm
- **calibmag** from **calibFlux**: flux within a 12.0-pixel aperture

Also, for the magnitudes, the results are almost the same, confirming that FrDF processing is able to reproduce the data produced at IDF.

```{figure} ./images/source_12px.png
```

```{figure} ./images/source_12px_diff.png
```

## References

```{bibliography}
```
